name: Daily Sync New Facebook Videos to YouTube

on:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:
    # Allow manual trigger with options
    inputs:
      full_sync:
        description: 'Full sync of all videos (not just new ones)'
        required: false
        default: 'false'
        type: boolean
      playlist_name:
        description: 'YouTube playlist name'
        required: false
        default: 'Da Facebook'
        type: string

jobs:
  sync-videos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Git LFS
        run: |
          git lfs install
          mkdir -p temp-video

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Sync new Facebook videos to YouTube
        env:
          FB_ACCESS_TOKEN: ${{ secrets.FB_ACCESS_TOKEN }}
          FB_PAGE_ID: ${{ secrets.FB_PAGE_ID }}
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
        run: |
          if [ "${{ github.event.inputs.full_sync }}" = "true" ]; then
            echo "‚ö†Ô∏è  WARNING: Using full sync in daily workflow!"
            echo "üí° For full sync, use 'Full Sync Facebook Videos to YouTube' workflow instead"
            node scripts/sync-fb-youtube.js --full --playlist="${{ github.event.inputs.playlist_name || 'Da Facebook' }}"
          else
            echo "üîÑ Running incremental sync for new videos only..."
            node scripts/sync-fb-youtube.js --playlist="${{ github.event.inputs.playlist_name || 'Da Facebook' }}"
          fi

      - name: Cleanup temporary video files
        run: |
          if [ -d "temp-video" ] && [ "$(ls -A temp-video)" ]; then
            echo "Cleaning up temporary video files..."
            rm -rf temp-video/*
            git add temp-video/
            git commit -m "Clean temporary video storage after sync" || echo "No temp files to clean"
            git push || echo "Nothing to push for cleanup"
          else
            echo "No temporary files to clean"
          fi

      - name: Commit video metadata updates
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add data/videos.json || echo "No videos.json to add"
            git commit -m "Update video metadata from Facebook sync ü§ñ

            Generated with Claude Code (https://claude.ai/code)
            
            Co-Authored-By: Claude <noreply@anthropic.com>" || echo "No changes to commit"
            git push || echo "Nothing to push"
          else
            echo "No changes to commit"
          fi